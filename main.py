import asyncio
import logging
import os
import re
from datetime import datetime

from fastapi import FastAPI, Request, Response
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import Command  # Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù…Ø¨ÙˆØ±Øª

# ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==================
TOKEN = os.getenv("TOKEN")

ALLOWED_GROUP_IDS = [-1001224326322, -1002370282238]

GROUP_USERNAME = None

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

def normalize_digits(text: str) -> str:
    trans = str.maketrans(
        'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Ù Ù¡Ù¢Ù£Û´ÛµÛ¶Û·Û¸Û¹',
        '012345678901234567890123456789'
    )
    return text.translate(trans)

PHONE_PATTERN = re.compile(
    r'(?:\+?966|00966|966|05|5|0)?'
    r'(\d[\s\W_*/.-]*){8,12}',
    re.IGNORECASE
)

PHONE_CONTEXT_PATTERN = re.compile(
    r'(?:Ø§ØªØµÙ„|Ø±Ù‚Ù…ÙŠ|ÙˆØ§ØªØ³|Ù‡Ø§ØªÙ|Ù…ÙˆØ¨Ø§ÙŠÙ„|mobile|phone|call|contact|whatsapp|ÙˆØ§ØªØ³Ø§Ø¨|ğŸ“|â˜ï¸)[\s\W_*/]{0,10}'
    r'(?:\+\d{1,4}[\s\W_*/.-]*\d{5,15}|\d{9,15})',
    re.IGNORECASE | re.UNICODE
)

WHATSAPP_INVITE_PATTERN = re.compile(r'(?:https?://)?(?:chat\.whatsapp\.com|wa\.me)/[^\s]*|\+\w{8,}', re.IGNORECASE)
TELEGRAM_INVITE_PATTERN = re.compile(
    r'(?:https?://)?t\.me/(?:joinchat/|[+])[\w-]{10,}|(?:https?://)?t\.me/(?!' + (GROUP_USERNAME or '') + r')[^\s/]+',
    re.IGNORECASE
)
TIKTOK_PATTERN = re.compile(r'(?:https?://)?(?:vm\.|www\.)?tiktok\.com/[^\s]*', re.IGNORECASE)
SHORT_LINK_PATTERN = re.compile(r'(?:https?://)?(bit\.ly|tinyurl\.com|goo\.gl|t\.co)/[^\s]*', re.IGNORECASE)

ALLOWED_DOMAINS = ["youtube.com", "youtu.be", "instagram.com", "instagr.am", "x.com", "twitter.com"]

async def is_admin(chat_id: int, user_id: int) -> bool:
    try:
        member = await bot.get_chat_member(chat_id, user_id)
        return member.status in ("administrator", "creator")
    except Exception:
        return False

async def is_banned(chat_id: int, user_id: int) -> bool:
    try:
        member = await bot.get_chat_member(chat_id, user_id)
        return member.status in ("kicked", "banned", "left")
    except Exception:
        return True

def contains_spam(text: str) -> bool:
    if not text:
        return False

    normalized = normalize_digits(text)

    if PHONE_PATTERN.search(normalized):
        return True

    if PHONE_CONTEXT_PATTERN.search(normalized):
        return True

    if (WHATSAPP_INVITE_PATTERN.search(text) or
        TELEGRAM_INVITE_PATTERN.search(text) or
        TIKTOK_PATTERN.search(text) or
        SHORT_LINK_PATTERN.search(text)):
        return True

    urls = re.findall(r'https?://[^\s]+|www\.[^\s]+|[^\s]+\.[^\s]{2,}', text, re.IGNORECASE)
    for url in urls:
        clean_url = url.replace(' ', '').lower()
        if not any(domain in clean_url for domain in ALLOWED_DOMAINS):
            return True

    has_phone = bool(PHONE_PATTERN.search(normalized))
    has_link = bool(re.search(r'https?://|www\.|[^\s]+\.[^\s/]+', text, re.IGNORECASE))
    if has_phone and has_link:
        return True

    return False

@dp.message()
async def check_message(message: types.Message):
    if message.chat.type == 'private':
        if not message.text or not message.text.lstrip().startswith('/start'):
            contact_text = (
                "ğŸ›¡ï¸ <b>Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ùƒ Ø¨Ø¨ÙˆØª Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù†ÙŠ!</b>\n\n"
                "ğŸ”’ Ù†Ø­Ù† Ù†Ù‚Ø¯Ù… Ø£Ù‚ÙˆÙ‰ Ø­Ù…Ø§ÙŠØ© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¨Ø§Ù…ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©.\n\n"
                "ğŸ“© <b>Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ Ø£Ùˆ Ø·Ù„Ø¨ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©:</b>\n"
                "ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù‡Ù†Ø§ ğŸ‘‡"
            )

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø§Ù„Ø¢Ù†", url="https://t.me/ql_om")],
                [InlineKeyboardButton(text="ğŸŒŸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©", callback_data="more_info")]
            ])

            await message.answer(contact_text, reply_markup=keyboard, disable_web_page_preview=True)
        return

    if message.chat.id not in ALLOWED_GROUP_IDS:
        return

    user_id = message.from_user.id
    chat_id = message.chat.id

    if await is_admin(chat_id, user_id):
        return

    text = (message.text or message.caption or "").strip()
    if not contains_spam(text):
        return

    try:
        await message.delete()
    except Exception as e:
        logger.warning(f"ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© {message.message_id}: {e}")

    if not await is_banned(chat_id, user_id):
        try:
            await bot.ban_chat_member(chat_id, user_id)
            banned = True
        except Exception as e:
            logger.warning(f"ÙØ´Ù„ Ø­Ø¸Ø± Ø§Ù„Ø¹Ø¶Ùˆ {user_id}: {e}")
            banned = False
    else:
        banned = False

    full_name = message.from_user.full_name

    if banned:
        notification = (
            f"ğŸš« <b>ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§</b>\n\n"
            f"ğŸ‘¤ <a href='tg://user?id={user_id}'>{full_name}</a>\n"
            f"ğŸ“› Ø§Ù„Ø³Ø¨Ø¨: Ù†Ø´Ø± Ø³Ø¨Ø§Ù… (Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ù…Ø´Ø¨ÙˆÙ‡)\n"
            f"ğŸ›¡ï¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…ÙŠØ©"
        )
    else:
        notification = (
            f"ğŸ—‘ï¸ <b>ØªÙ… Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø³Ø¨Ø§Ù…</b>\n\n"
            f"ğŸ‘¤ <a href='tg://user?id={user_id}'>{full_name}</a>\n"
            f"âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø­Ø¸ÙˆØ± Ù…Ø³Ø¨Ù‚Ù‹Ø§"
        )

    try:
        notify_msg = await bot.send_message(chat_id, notification)
        asyncio.create_task(delete_after_delay(notify_msg, 120))
    except Exception as e:
        logger.warning(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: {e}")

async def delete_after_delay(message: types.Message, delay: int = 120):
    await asyncio.sleep(delay)
    try:
        await message.delete()
    except Exception:
        pass

# Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ÙŠÙ‚Ø¨Ù„ /start Ù…Ø¹ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† payload (Ù…Ø«Ù„ Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø²Ø±Ù‚)
@dp.message(Command(commands=["start"]))
async def start_command(message: types.Message):
    logger.info(f"Received /start (including blue button) from user {message.from_user.id}")

    intro_text = (
        "ğŸ›¡ï¸ <b>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ!</b>\n\n"
        "ğŸ”’ <i>Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ù…ØµÙ…Ù… Ø®ØµÙŠØµÙ‹Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£Ù…Ø§Ù† Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø³Ø¨Ø§Ù…ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©. ÙŠØ¹Ù…Ù„ Ø¨Ø°ÙƒØ§Ø¡ Ø¹Ø§Ù„ÙŠ Ù„ÙƒØ´Ù Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ù…Ø¹ Ø­Ø¸Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ†.</i>\n\n"
        "ğŸ“Œ <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ø¯ÙŠÙ†Ø§.\n\n"
        "ğŸŒŸ Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ Ø£Ùˆ Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ù† Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ ğŸ‘‡"
    )

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ Ø§Ù„Ø¢Ù†", url="https://t.me/ql_om")],
        [InlineKeyboardButton(text="â“ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ùˆ Ø§Ø³ØªÙØ³Ø§Ø±", url="https://t.me/ql_om")],
        [InlineKeyboardButton(text="ğŸŒŸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©", callback_data="more_info")]
    ])

    await message.answer(intro_text, reply_markup=keyboard, disable_web_page_preview=True)

@dp.callback_query()
async def handle_callback_query(callback: types.CallbackQuery):
    if callback.data == "more_info":
        more_info_text = (
            "ğŸ›¡ï¸ <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø¨ÙˆØª Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù†ÙŠ</b>\n\n"
            "ğŸ”¥ <b>Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø¨ÙˆØª ÙˆÙƒÙŠÙ ÙŠØ¹Ù…Ù„ØŸ</b>\n"
            "Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ Ù…ØµÙ…Ù… Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³Ø¨Ø§Ù… ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø²Ø¹Ø¬. ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªÙ‚Ù†ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ÙƒØ´Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ (Ø­ØªÙ‰ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù…Ø«Ù„ 0/5/6/9/6/6/7/0 Ø£Ùˆ Ø¨Ø£ÙŠ Ø´ÙƒÙ„ Ø¢Ø®Ø±)ØŒ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø© (Ù…Ø«Ù„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø§Ù„ØªÙŠÙƒ ØªÙˆÙƒØŒ Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø· Ù…Ø®ØªØµØ±Ø©)ØŒ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¶Ø±Ø©. ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ù‹Ø§ ÙˆØ­Ø¸Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø£ÙˆÙ„ Ù…Ø®Ø§Ù„ÙØ©! ğŸš«\n\n"
            "ğŸ›¡ï¸ <b>Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</b>\n"
            "â€¢ ğŸ“ <b>ÙƒØ´Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ:</b> ÙŠØ¯Ø¹Ù… ÙƒÙ„ Ø§Ù„Ø­ÙŠÙ„ Ù…Ø«Ù„ Ø§Ù„ÙÙˆØ§ØµÙ„ØŒ Ø§Ù„Ø±Ù…ÙˆØ²ØŒ Ø£Ùˆ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/ÙØ§Ø±Ø³ÙŠØ©ØŒ ÙˆØ¨Ø§Ø¯Ø¦Ø§Øª Ø³Ø¹ÙˆØ¯ÙŠØ©/Ø®Ù„ÙŠØ¬ÙŠØ© (+966ØŒ 05ØŒ Ø¥Ù„Ø®).\n"
            "â€¢ ğŸ”— <b>ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©:</b> ÙŠÙ…Ù†Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©ØŒ Ø§Ù„ØªÙŠÙƒ ØªÙˆÙƒØŒ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø©ØŒ Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© Ù…Ø«Ù„ ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ø¥Ù†Ø³ØªØºØ±Ø§Ù….\n"
            "â€¢ ğŸ”„ <b>Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±:</b> ÙŠØ­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¨Ø³Ø±Ø¹Ø© ÙƒØ¨ÙŠØ±Ø©ØŒ ÙˆÙŠØ­Ø¸Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯ÙˆÙ† ØªÙˆÙ‚Ù.\n"
            "â€¢ ğŸ“¢ <b>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ù…Ù†ÙŠØ©:</b> ÙŠØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ù‹Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù† Ø§Ù„Ø­Ø¸Ø± Ø£Ùˆ Ø§Ù„Ø­Ø°ÙØŒ ÙŠØ®ØªÙÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†.\n\n"
            "âš ï¸ <b>ÙƒÙŠÙÙŠØ© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ:</b>\n"
            "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ. ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¯ÙŠÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„ÙƒÙØ§Ø¡Ø©. Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø³Ù†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙˆØª Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ ÙˆÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ ÙÙˆØ±Ù‹Ø§! ğŸ“\n\n"
            "ğŸ“© <b>Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø£Ùˆ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ:</b> ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø§Ù„Ø¢Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ù…Ø§ÙŠØ© ÙØ§Ø¦Ù‚Ø© ÙˆÙ†Ø³Ø®Ø© Ù…Ø®ØµØµØ© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª. Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ! ğŸ‘‡"
        )

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ù„ØªØ³Ø¬ÙŠÙ„", url="https://t.me/ql_om")]
        ])

        await callback.message.answer(more_info_text, reply_markup=keyboard, disable_web_page_preview=True)
        await callback.answer()

app = FastAPI()

WEBHOOK_PATH = f"/bot/{TOKEN}"
WEBHOOK_URL = f"https://{os.getenv('RENDER_EXTERNAL_HOSTNAME')}{WEBHOOK_PATH}"

@app.on_event("startup")
async def on_startup():
    try:
        await bot.delete_webhook(drop_pending_updates=True)
        await bot.set_webhook(url=WEBHOOK_URL)
        logger.info(f"Webhook ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­: {WEBHOOK_URL}")
    except Exception as e:
        logger.error(f"ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ webhook: {e}")

@app.on_event("shutdown")
async def on_shutdown():
    await bot.session.close()

@app.post(WEBHOOK_PATH)
async def webhook(request: Request):
    try:
        update_dict = await request.json()
        update = types.Update.model_validate(update_dict, context={"bot": bot})
        await dp.feed_update(bot=bot, update=update)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: {e}")
    return Response(content="OK", status_code=200)

@app.get("/")
async def root():
    return {"status": "Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­! ğŸŸ¢"}